# Использование Rdx сериализации на примере децентрализованного чата

Проекты RdxChat и Domain релизуют клиент децентрализованного чата для P2P общения между пользователями, в основе которого лежит передача сообщений с помощью WebSocket. В данный момент поддерживается общение между двумя пользователями. Процесс запуска клиента на локальной машине описан в разделе "Запуск".

## Идея

RdxChat представляет собой клиент-серверное приложение на ASP.NET Core, запускающееся пользователем на его машине.

Для установления контакта с собеседником пользователю предлагается ввести имя, которым он будет представляться, и код собеседника. Коды автоматически генерируются клиентом, сохраняются в Cookies браузера и по совместительству являются идентификатором пользователя в системе.

Независимо от того, существует ли пользователь с введенным кодом или нет, текущий клиент будет переведен на страницу чата. Здесь ему продоставляется возможность отправлять сообщения и отслеживать всю историю переписки с собеседником, чей код был введен ранее.

Общение между пользователями является децентрализованным и построено на следующей идее: когда пользователь отправляет или получает сообщение, он сохраняет его копию на своей машине, при этом в сообщение включаются такие реквизиты, как:
* Текст сообщения
* ID отправителя
* Имя отправителя
* ID получателя
* Время отправления сообщения
* ID сообщения

В случае, если соединение с собеседником было разорвано, отправляемые сообщения все равно сохранятся локально, а при повторном подключении произойдет синхронизация истории сообщений - собеседник получит сообщения, не доставленные ранее, и сохранит их у себя локально. Таким образом история переписки разделяется между пользователями, но будет одинаковой у обоих собеседников в случае подключения.

Никакие данные переписок не хранятся на внешних серверах, так что история переписки может быть изменена только в случае, если у обоих пользователей отсутствуют сообщения с определенным ID.

## Реализация

Для построения децентрализованного чата используется протокол WebSocket в качестве инструмента передачи сообщений по сети.

Для общения клиенту требуется запустить приложение локально, предварительно указав в нем адрес подключения к WebSocket серверу - единственному централизованному элементу системы, который используется исключительно для доставки сообщений клиентам.

После запуска приложения пользователю станет доступен Web-интерфейс, через который можно удобно вести переписку. Общение интерфейса с backend частью приложения происходит через SignalR и HTTP-запросы на адрес локально запущенного приложения.

Для передачи сообщений и синхронизации истории клиент WebSocket настроен по принципу, описанному в разделе "Идея". Все сообщения перед сохранением и отправкой предварительно сериализуются или десериализуются в RDX структуру данных.

## Запуск

Для выполнения сборки приложения, находясь в директории проекта, введите в терминале команду
```
dotnet build
```
Для запуска приложения локально, перейдите в субдиректорию `RdxChat` проекта и введите в терминале
```
dotnet run
```
После этого в терминале можно будет увидеть адрес, по которому доступно приложение (ниже приведен консольный вывод при конфигурации приложения по умолчанию):
```
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5238
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: project\parent\dir\RdxChat\RdxChat
```
Конфигурация порта приложения может быть выполнена в файле `launchSettings.json`.

## Технические ограничения

Из-за сложности хранения данных для отдельных пользователей в памяти в процессе работы приложения, может наблюдаться дефект: при подключении к одному серверу, сообщения становятся видны всем пользователям системы, и сохраняются локально на их машинах, даже если они не являются их отправителем и получателем. Решить проблему можно передачей сообщений через внешний сервер WebSocket с разных машин. Также стоит следовать инструкциям, приведенным в комментариях к коду в файле `WebSocketHandler.cs`, если вы решили перейти на внешний сервер WebSocket или запускаете приложение с разных машин одной локальной сети.

Ранее рассматривалась возможность добавления шифрования сообщений и поддержки аутентификации пользователей, но в процессе разработки эта идея была отвергнута, поскольку во главе стола стояла идея показать реализацию именно децентрализованно работающего приложения, а шифрование и аутентификация могли бы послужить хорошей и правильной надстройкой над децентрализованным приложением, но не его основной функциональностью.