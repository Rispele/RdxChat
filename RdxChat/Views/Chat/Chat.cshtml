@model RdxChat.Entities.ChatModel

<link rel="stylesheet" href="css/chat.css">

<div class="chat">
    <div class="chat-header clearfix">
        <div class="chat-about">
            <div class="chat-with">@Model.CompanionName</div>
        </div>
    </div>

    <div class="chat-history">
        <ul class="chat-history-list">
            @foreach (var message in Model.Messages)
            {
                if (message.UserId == Model.UserId)
                {
                    <li class="clearfix">
                        <div class="message-data align-right">
                            <div class="message-data-name">@message.UserName</div>
                            <div class="message-data-time">@message.SendingTime.ToString("dd.MM.yy H:mm")</div>
                        </div>
                        <div class="message other-message float-right">
                            @message.Message
                        </div>
                    </li>
                }
                else
                {
                    <li>
                        <div class="message-data">
                            <div class="message-data-name">@message.UserName</div>
                            <div class="message-data-time">@message.SendingTime.ToString("dd.MM.yy H:mm")</div>
                        </div>
                        <div class="message my-message">
                            @message.Message
                        </div>
                    </li>
                }
            }

        </ul>
    </div>

    <div class="chat-message clearfix">
        <textarea name="message-to-send" id="message-to-send" placeholder ="Введите ваше сообщение" rows="3"></textarea>
        <button class="send">Отправить</button>
    </div>
</div>

<script src="/js/signalr/dist/browser/signalr.js"></script>
<script type="module">
    const connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

    connection.on("NotifyMessage", async function (messageDto) {
        const messageModel = JSON.parse(messageDto);
        const response = await fetch('/save-message', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                Message: messageModel['Message'],
                ReceiverId: messageModel['ReceiverId'],
                SenderId: messageModel['SenderId'],
                SavePath: messageModel['ReceiverId']
            })
        });
        
        const li = document.createElement("li");
        const messageData = document.createElement("div");
        messageData.className = "message-data";
        const messageDataName = document.createElement("div");
        messageDataName.className = "message-data-name";
        messageDataName.innerText = "@Model.CompanionName";
        const messageDataTime = document.createElement("div");
        messageDataTime.className = "message-data-time";
        const time = new Date().toLocaleString("ru");
        messageDataTime.innerText = `${time.substring(0, 6)}${time.substring(8, 10)} ${time.substring(12, 17)}`;
        const messageBlock = document.createElement("div");
        messageBlock.className = "message my-message";
        messageBlock.innerText = messageModel['Message'];

        messageData.appendChild(messageDataName);
        messageData.appendChild(messageDataTime);
        li.appendChild(messageData);
        li.appendChild(messageBlock);
        
        document.getElementsByClassName("chat-history-list")[0].appendChild(li);
        const history = document.getElementsByClassName("chat-history")[0];
        history.scrollTo(0, history.scrollHeight);
    });
    
    connection.start();
    
    document.getElementsByClassName("send")[0].addEventListener('click', async function () {
        const message = document.getElementById("message-to-send").value;
        
        if (message.length === 0) {
            return;
        }
        
        const li = document.createElement("li");
        li.className = "clearfix";
        const messageData = document.createElement("div");
        messageData.className = "message-data align-right";
        const messageDataName = document.createElement("div");
        messageDataName.className = "message-data-name";
        messageDataName.innerText = "@Model.UserName";
        const messageDataTime = document.createElement("div");
        messageDataTime.className = "message-data-time";
        const time = new Date().toLocaleString("ru");
        messageDataTime.innerText = `${time.substring(0, 6)}${time.substring(8, 10)} ${time.substring(12, 17)}`;
        const messageBlock = document.createElement("div");
        messageBlock.className = "message other-message float-right";
        messageBlock.innerText = message;
        
        messageData.appendChild(messageDataName);
        messageData.appendChild(messageDataTime);
        li.appendChild(messageData);
        li.appendChild(messageBlock);
        document.getElementsByClassName("chat-history-list")[0].appendChild(li);
        const history = document.getElementsByClassName("chat-history")[0];
        history.scrollTo(0, history.scrollHeight);

        const response = await fetch('/save-message', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                Message: message,
                ReceiverId: '@Model.CompanionId',
                SenderId: '@Model.UserId',
                SavePath:'@Model.UserId'
            })
        });
        await connection.invoke("SendMessage", message, '@Model.CompanionId', '@Model.UserId');

        document.getElementById("message-to-send").value = "";
    });
    
</script>